# Reference: https://github.com/lima-vm/lima/blob/master/templates/default.yaml

param:
  dataMountPath: /mnt/lima-dev-data
  vmStateFile: .vmstate

vmType: "vz"

os: "Linux"

cpus: 8
disk: "30GiB"
memory: "16GiB"

mountType: "virtiofs"
mounts: []

additionalDisks: []

images:
  - location: "https://cloud-images.ubuntu.com/releases/plucky/release-20250701/ubuntu-25.04-server-cloudimg-arm64.img"
    arch: "aarch64"
    digest: "sha256:26d0ac2236f12954923eb35ddfee8fa9fff3eab6111ba84786b98ab3b972c6d8"

user:
  name: limadev
  home: /home/limadev
  shell: /bin/zsh

ssh:
  localPort: 60022
  forwardAgent: true
  loadDotSSHPubKeys: null

env:
  DOTFILES_DIR: "/home/limadev/dotfiles"

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Setup data mount permissions
      chown -R "{{.User}}" "{{.Param.dataMountPath}}"
      
      # Install and update packages
      export DEBIAN_FRONTEND=noninteractive

      apt-get update -y
      apt-get dist-upgrade -y
      apt-get autoremove -y
      apt-get install zsh git make neovim unzip zip tmux -y

      stateFile="{{.Home}}/{{.Param.vmStateFile}}"
      
      touch "$stateFile"
      chown "{{.User}}" "$stateFile"

  # Setup additional Playwright dependencies
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      stateText="playwright"
      stateFile="{{.Home}}/{{.Param.vmStateFile}}"

      if grep -Fxq "$stateText" "$stateFile"; then
        echo "Additional Playwright dependencies already setup, skipping..."
        exit 0
      fi

      wget -O /tmp/libicu74.deb http://ports.ubuntu.com/pool/main/i/icu/libicu74_74.2-1ubuntu3.1_arm64.deb
      dpkg -i /tmp/libicu74.deb
      apt-get install -f -y
      rm /tmp/libicu74.deb
      echo "libicu74 installed successfully"

      apt-get install libatk1.0-0t64 \
        libatk-bridge2.0-0t64 \
        libcups2t64 \
        libatspi2.0-0t64 \
        libxcomposite1 \
        libxdamage1 \
        libxfixes3 \
        libxrandr2 \
        libgbm1 \
        libcairo2 \
        libpango-1.0-0 \
        libasound2t64 \
        libxcursor1 \
        libgtk-3-0t64 \
        libpangocairo-1.0-0 \
        libcairo-gobject2 \
        libgdk-pixbuf-2.0-0

      echo "$stateText" >> "$stateFile"
      chown "{{.User}}" "$stateFile"

  # Setup Docker
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      stateText="docker"
      stateFile="{{.Home}}/{{.Param.vmStateFile}}"

      if grep -Fxq "$stateText" "$stateFile"; then
        echo "Docker is already setup, skipping..."
        exit 0
      fi

      echo "Docker not found, proceeding with installation..."

      export DEBIAN_FRONTEND=noninteractive

      apt-get update -y

      # Add Docker's official GPG key:
      apt-get install ca-certificates curl -y
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      chmod a+r /etc/apt/keyrings/docker.asc

      # Add Docker's repository to Apt sources:
      echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
        $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
        tee /etc/apt/sources.list.d/docker.list > /dev/null
      apt-get update -y

      apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y

      groupadd docker || echo "Group docker already exists"
      usermod -aG docker {{.User}}

      echo "$stateText" >> "$stateFile"
      chown "{{.User}}" "$stateFile"

  # Setup dotfiles
  - mode: user
    script: |
      #!/bin/zsh
      set -eux -o pipefail

      if [ -e "{{.Param.dataMountPath}}/config/.zshenv.local" ]; then
        echo "Creating a symlink to .zshenv.local"
        ln -sf "{{.Param.dataMountPath}}/config/.zshenv.local" "$HOME/.zshenv.local"
      fi

      if [ -e "{{.Param.dataMountPath}}/config/.gitconfig" ]; then
        echo "Creating a symlink to .gitconfig"
        ln -sf "{{.Param.dataMountPath}}/config/.gitconfig" "$HOME/.gitconfig"
      fi

      if [ -e "{{.Param.dataMountPath}}/config/ssh/config" ]; then
        echo "Creating a symlink to ssh/config"
        mkdir -p $HOME/.ssh
        ln -sf "{{.Param.dataMountPath}}/config/ssh/config" "$HOME/.ssh/config"
      fi

      echo "$DOTFILES_DIR does not exist, will setup"

      cd $HOME

      git clone https://github.com/vytautasjc/dotfiles.git $DOTFILES_DIR
      
      cd $DOTFILES_DIR

      make zsh git tmux

  # Install NVM
  - mode: user
    script: |
      #!/bin/zsh
      set -eux -o pipefail

      stateText="nvm"
      stateFile="{{.Home}}/{{.Param.vmStateFile}}"

      if grep -Fxq "$stateText" "$stateFile"; then
        echo "NVM is already setup, skipping..."
        exit 0
      fi

      export DEBIANT_FRONTEND=noninteractive

      # Do not edit shell config files
      PROFILE=/dev/null bash -c 'curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash'

      NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" --no-use

      nvm install node
      nvm alias default node

      echo "$stateText" >> "$stateFile"

  # Install SDKMAN
  - mode: user
    script: |
      #!/bin/zsh
      
      ### Do not set -u to not treat unbound variables as error:
      ### sdkman-init.sh: line 20: SDKMAN_CANDIDATES_API: unbound variable
      set -ex -o pipefail

      stateText="sdkman"
      stateFile="{{.Home}}/{{.Param.vmStateFile}}"

      if grep -Fxq "$stateText" "$stateFile"; then
        echo "SDKMAN is already setup, skipping..."
        exit 0
      fi

      export DEBIANT_FRONTEND=noninteractive

      curl -s "https://get.sdkman.io?ci=true&rcupdate=false" | bash
      . "$HOME/.sdkman/bin/sdkman-init.sh"

      sdk install java 25-open
      sdk install java 25-graalce

      echo "$stateText" >> "$stateFile"

  # Misc
  - mode: user
    script: |
      #!/bin/zsh
      set -eux -o pipefail

      source $HOME/.zshenv
      source $ZDOTDIR/.zshrc

      link_data_dir() {
        src_dir="$1"         # The directory under $HOME to manage (e.g., $HOME/.config/JetBrains)
        target_dir="$2"      # The directory to create/link to (e.g., /mount/path/JetBrains/config)

        if [ ! -d "$src_dir" ]; then
          src_parent_dir="${src_dir%/*}"

          mkdir -p "$target_dir" "$src_parent_dir"
          ln -s "$target_dir" "$src_dir"
        fi
      }

      NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" --no-use

      nvm use default

      link_data_dir "$HOME/development" "{{.Param.dataMountPath}}/development"
      link_data_dir "$HOME/.config/codex" "{{.Param.dataMountPath}}/config/codex"
      link_data_dir "$HOME/.config/claude" "{{.Param.dataMountPath}}/config/claude"
      link_data_dir "$HOME/.config/gemini" "{{.Param.dataMountPath}}/config/gemini"

      # Until https://github.com/google-gemini/gemini-cli/issues/1825 is fixed
      ln -s "$HOME/.config/gemini" "$HOME/.gemini"

      npm install -g pnpm

      # Install agents
      pnpm install -g @openai/codex
      pnpm install -g @anthropic-ai/claude-code
      pnpm install -g @google/gemini-cli

      cd $DOTFILES_DIR
      make gemini codex

      # Setup IntelliJ config location

      jetbrains_config_dir="$HOME/.config/JetBrains"
      jetbrains_local_dir="$HOME/.config/local/share/JetBrains"
      jetbrains_cache_dir="$HOME/.config/cache/JetBrains"
      
      jetbrains_data_mount_path="{{.Param.dataMountPath}}/config/JetBrains"

      link_data_dir "$jetbrains_config_dir" "$jetbrains_data_mount_path/config"
      link_data_dir "$jetbrains_local_dir" "$jetbrains_data_mount_path/local"
      link_data_dir "$jetbrains_cache_dir" "$jetbrains_data_mount_path/cache"
